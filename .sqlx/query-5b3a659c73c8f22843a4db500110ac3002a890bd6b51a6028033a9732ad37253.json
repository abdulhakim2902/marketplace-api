{
  "db_name": "PostgreSQL",
  "query": "\n            WITH\n                bought_activities AS (\n                    SELECT a.collection_id, a.receiver AS address, COUNT(*) AS bought, SUM(price) AS price FROM activities a\n                    WHERE a.tx_type = 'buy' AND a.collection_id = $1\n                    GROUP BY a.collection_id, a.receiver \n                ),\n                sold_activities AS (\n                    SELECT a.collection_id, a.sender AS address, COUNT(*) AS sold, SUM(price) AS price FROM activities a\n                    WHERE a.tx_type = 'buy' AND a.collection_id = $1\n                    GROUP BY a.collection_id, a.sender\n                ),\n                unique_addresses AS (\n                    SELECT ba.address FROM bought_activities ba\n                    UNION\n                    SELECT sa.address FROM sold_activities sa\n                )\n            SELECT\n                ua.address,\n                ba.bought, \n                sa.sold, \n                ba.price                                                                AS spent,\n                (COALESCE(sa.price, 0) - COALESCE(ba.price, 0)) \t                    AS total_profit,\n                (COALESCE(sa.price, 0) - COALESCE(ba.price, 0)) / NULLIF (ba.price, 0) \tAS profit_percentage\n            FROM unique_addresses ua\n                LEFT JOIN bought_activities ba ON ba.address = ua.address\n                LEFT JOIN sold_activities sa ON sa.address = ua.address\n            WHERE ua.address IS NOT NULL\n            ORDER BY total_profit DESC\n            LIMIT $2 OFFSET $3\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "address",
        "type_info": "Varchar"
      },
      {
        "ordinal": 1,
        "name": "bought",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "sold",
        "type_info": "Int8"
      },
      {
        "ordinal": 3,
        "name": "spent",
        "type_info": "Numeric"
      },
      {
        "ordinal": 4,
        "name": "total_profit",
        "type_info": "Numeric"
      },
      {
        "ordinal": 5,
        "name": "profit_percentage",
        "type_info": "Numeric"
      }
    ],
    "parameters": {
      "Left": [
        "Text",
        "Int8",
        "Int8"
      ]
    },
    "nullable": [
      null,
      null,
      null,
      null,
      null,
      null
    ]
  },
  "hash": "5b3a659c73c8f22843a4db500110ac3002a890bd6b51a6028033a9732ad37253"
}
